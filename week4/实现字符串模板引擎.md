# 实现字符串模板引擎

## 前言

字符串模板引擎是前端开发中常用的工具，它允许我们在字符串中嵌入变量和控制流逻辑，动态生成内容。本文将详细分析一个 的模板引擎实现，探讨其核心原理和实现细节。

## 功能特性

我们实现的模板引擎支持以下功能：

1. **变量插值**：使用 `<%= variable %>` 语法插入变量值
2. **控制流语句**：支持 `if/else` 条件判断和 `for` 循环
3. **JavaScript 表达式**：在模板中执行任意 JavaScript 代码
4. **错误处理**：提供详细的错误信息和异常处理

## 核心实现原理

### 1. 模板解析策略

模板引擎的核心思想是将模板字符串转换为可执行的 JavaScript 代码，然后在给定的数据上下文中执行这段代码。

```javascript
function template(tmpl, data) {
  // 解析模板，转换为可执行的JavaScript代码
  let code = 'let __output = "";\n';
  // ... 解析逻辑
  code += "return __output;";

  // 创建函数并执行
  const context = createContext(data);
  const func = new Function(...context.keys, code);
  return func(...context.values);
}
```

### 2. 数据上下文创建

`createContext` 函数负责将数据对象转换为函数参数：

```javascript
const createContext = (data) => {
  const keys = Object.keys(data);
  const values = Object.values(data);
  return { keys, values };
};
```

这种方法允许我们在生成的函数中直接访问数据对象的属性，而不需要通过 `data.property` 的方式。

### 3. 模板标签解析

模板解析采用逐字符扫描的方式，识别并处理不同类型的模板标签：

#### 文本内容处理

```javascript
// 处理普通文本，需要转义引号和换行符
const text = tmpl
  .slice(index, start)
  .replace(/"/g, '\\"')
  .replace(/\n/g, "\\n");
code += `__output += "${text}";\n`;
```

#### 插值表达式处理

```javascript
if (tag.startsWith("=")) {
  // <%= expression %> 形式的插值
  const expression = tag.slice(1).trim();
  code += `__output += String(${expression} || "");\n`;
}
```

#### 控制流语句处理

```javascript
else {
    // <% javascript code %> 形式的控制流
    code += `${tag}\n`;
}
```

## 实现


1. 创建输出变量 `__output` 和索引 `index`
2. 查找下一个 `<%` 标签位置
3. 将标签前的文本添加到输出
4. 根据标签类型生成相应的 JavaScript 代码
5. 组装完整的函数代码
6. 使用 `new Function` 创建并执行函数



为了确保生成的 JavaScript 代码正确，需要对文本中的特殊字符进行转义：

- 双引号：`"` → `\\"`
- 换行符：`\n` → `\\n`





```javascript
function template(tmpl, data) {
    const createContext = (data) => {
        const keys = Object.keys(data);
        const values = Object.values(data);
        return { keys, values };
    };
    
    let code = 'let __output = "";\n';
    let index = 0;
    
    while (index < tmpl.length) {
        const start = tmpl.indexOf('<%', index);
        
        if (start === -1) {
            const text = tmpl.slice(index).replace(/"/g, '\\"').replace(/\n/g, '\\n');
            if (text) {
                code += `__output += "${text}";\n`;
            }
            break;
        }
        
        if (start > index) {
            const text = tmpl.slice(index, start).replace(/"/g, '\\"').replace(/\n/g, '\\n');
            code += `__output += "${text}";\n`;
        }
        
        const end = tmpl.indexOf('%>', start);
        if (end === -1) {
            throw new Error('Unclosed template tag');
        }
        
        const tag = tmpl.slice(start + 2, end).trim();
        
        if (tag.startsWith('=')) {
            const expression = tag.slice(1).trim();
            code += `__output += String(${expression} || "");\n`;
        } else {
            code += `${tag}\n`;
        }
        
        index = end + 2;
    }
    
    code += 'return __output;';
    
    try {
        const context = createContext(data);
        const func = new Function(...context.keys, code);
        return func(...context.values);
    } catch (error) {
        throw new Error(`Template execution error: ${error.message}`);
    }
}


const result = template(`
    <ul>
  <% if (obj.show) { %>
    <% for (var i = 0; i < obj.users.length; i++) { %>
      <li>
        <a href="<%= obj.users[i].url %>">
          <%= obj.users[i].name %>
        </a>
      </li>
    <% } %>
  <% } else { %>
    <p>不展示列表</p>
  <% } %>
</ul>
    `, {obj: {show: false, users: [{name: '1', url: '1'}, {name: '2', url: '2'}]}})

console.log(result);



```

当 `obj.show` 为 `false` 时，输出：

```html
<ul>
  <p>不展示列表</p>
</ul>
```



## 总结

这个字符串模板引擎实现展示了模板引擎的核心原理：**模板解析 → 代码生成 → 动态执行**。虽然功能相对简单，但足以说明现代模板引擎的基本工作机制。

通过深入理解模板引擎的实现原理，我们可以更好地使用那些出名的模版工具，并在必要时进行定制化开发。
